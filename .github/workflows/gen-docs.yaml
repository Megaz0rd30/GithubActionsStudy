# This is a basic workflow to help you get started with Actions

name: doc-teste

# Controls when the workflow will run
on:
  - pull_request

permissions:
  actions: write
  pull-requests: write
  
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  generate_docs_paths:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    outputs:
      module_paths: ${{ steps.id_generate_docs.outputs.list_paths }}
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      - id: id_dep
        name: Install Dependencies
        run: |
          sudo apt update -y
          sudo apt install jq -y
        
      - id: id_generate_docs
        name: generate_docs
        run: |
          modulesPath=()
          for d in modules/*/ ; do
          
              echo "## Generating Cloud Provider > $d"

              for service_directory in $d*/ ; do
                  echo "+++Generating Service > $service_directory"
                  
                  for service_modules_directory in $service_directory*/ ; do
                      echo ">>>> Generating Service Module > $service_modules_directory"
                      modulesPath+=("$service_modules_directory")
                  done
              done
          done

          jsonValue=$(jq --compact-output --null-input '$ARGS.positional' --args -- "${modulesPath[@]}")
          jsonValue="{\"include\":{\"paths\":$jsonValue}}"
          jsonValue=$(sed 's|\"|\\"|g' <<< "$jsonValue")
          echo $jsonValue
          echo "list_paths=$jsonValue" >> "$GITHUB_OUTPUT"
  generate_readme:
    needs: generate_docs_paths
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      - name: Render terraform docs and push changes back to PR
        run: |
            curl -Lo ./terraform-docs.tar.gz https://github.com/terraform-docs/terraform-docs/releases/download/v0.16.0/terraform-docs-v0.16.0-$(uname)-amd64.tar.gz
            tar -xzf terraform-docs.tar.gz
            chmod +x terraform-docs
      - name: Generate Terraform Docs
        shell: bash
        run: |
          git config user.name "Megaz0rd30"
          git config user.email "gabrielcastro30@gmail.com"
          
          for d in modules/*/ ; do
            echo "## Generating Cloud Provider > $d"
            
            for service_directory in $d*/ ; do
                echo "+++Generating Service > $service_directory"

                for service_modules_directory in $service_directory*/ ; do
                    echo ">>>> Generating Service Module > $service_modules_directory"
                    #modulesPath+=("$service_modules_directory")
                    #./terraform-docs $service_modules_directory --output-file README.md
                    
                    #git add $service_modules_directory/README.md
                    
                done
            done
          done
          git commit -m "#$(date +%s) Update README.md"
          git push origin HEAD:${{ github.event.pull_request.head.ref }}