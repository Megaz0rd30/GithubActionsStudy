name: Generate Terraform Docs
on: push

jobs:
  # This workflow contains a single job called "build"
  generate_docs_paths:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    outputs:
      module_paths: ${{ steps.module_path.outputs.list_paths }}
    steps:
      - id: install_dependencies
        run: |
          apt update -y
          apt install jq -y

      - id: modules_path
        run: |
          modulesPath=()
          for d in modules/*/ ; do
          
              echo "## Generating Cloud Provider > $d"

              for service_directory in $d*/ ; do
                  echo "+++Generating Service > $service_directory"
                  
                  for service_modules_directory in $service_directory*/ ; do
                      echo ">>>> Generating Service Module > $service_modules_directory"
                      modulesPath+=("$service_modules_directory")
                  done
              done
          done

          jsonValue=$(jq --compact-output --null-input '$ARGS.positional' --args -- "${modulesPath[@]}")
          jsonValue="{\"paths\":$jsonValue}"
          jsonValue=$(sed 's|\"|\\"|g' <<< "$jsonValue")
          echo $jsonValue
          echo "list_paths=$jsonValue" >> "$GITHUB_OUTPUT"
  generate_readme:
    needs: generate_docs_path
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      - name: Render terraform docs and push changes back to PR
        run: |
            curl -Lo ./terraform-docs.tar.gz https://github.com/terraform-docs/terraform-docs/releases/download/v0.16.0/terraform-docs-v0.16.0-$(uname)-amd64.tar.gz
            tar -xzf terraform-docs.tar.gz
            chmod +x terraform-docs
      - name: Generate Terraform Docs
        shell: bash
        run: |
          git config user.name "Megaz0rd30"
          git config user.email "gabrielcastro30@gmail.com"
          
          for d in modules/*/ ; do
            echo "## Generating Cloud Provider > $d"
            
            for service_directory in $d*/ ; do
                echo "+++Generating Service > $service_directory"

                for service_modules_directory in $service_directory*/ ; do
                    echo ">>>> Generating Service Module > $service_modules_directory"
                    #modulesPath+=("$service_modules_directory")
                    ./terraform-docs $service_modules_directory --output-file README.md
                    
                    git add $service_modules_directory/README.md
                    
                done
            done
          done
          git commit -m "#$(date +%s) Update README.md"
          git push origin HEAD:${{ github.event.pull_request.head.ref }}
            
