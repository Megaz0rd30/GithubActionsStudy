name: Generate Terraform Docs
on: [workflow_dispatch]

jobs:
  generate_docs_path:
    runs-on: ubuntu-latest
    outputs:
      module_paths: ${{ steps.module_path.outputs.list_paths }}
    steps:
      - id: install_dependencies
        run: |
          apt update -y
          apt install jq -y

      - id: modules_path
        run: |
          modulesPath=()
          for d in modules/*/ ; do
          
              echo "## Generating Cloud Provider > $d"

              for service_directory in $d*/ ; do
                  echo "+++Generating Service > $service_directory"
                  
                  for service_modules_directory in $service_directory*/ ; do
                      echo ">>>> Generating Service Module > $service_modules_directory"
                      modulesPath+=("$service_modules_directory")
                  done
              done
          done

          jsonValue=$(jq --compact-output --null-input '$ARGS.positional' --args -- "${modulesPath[@]}")
          jsonValue="{\"paths\":$jsonValue}"
          jsonValue=$(sed 's|\"|\\"|g' <<< "$jsonValue")
          echo $jsonValue
          echo "list_paths=$jsonValue" >> "$GITHUB_OUTPUT"
  generate_readme:
    needs: generate_docs_path
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJSON(needs.generate_docs_path.outputs.module_paths) }}
